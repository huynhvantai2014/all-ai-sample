# 画面定義書 - 仮販売一覧画面

---

**画面名**：仮販売一覧画面
**画面ID**：SRC0003
**画面物理名**：provisional_order_list
**URL**：/provisional_order_list

## 画面で使用するAPI一覧

### API 1: 仮販売一覧取得API

---
**API ID**: PROV003
**API名**: 仮販売一覧取得
**エンドポイント**: /api/provisional-orders
**メソッド**: GET

#### 1. 機能概要 (Tóm tắt chức năng)
- 仮販売一覧を取得し、検索・フィルタ・ソート機能を提供する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| status       | query |     | string | 20 | 状態フィルタ（pending/confirmed/cancelled/expired） |
| dateFrom     | query |     | date | 10 | 作成日開始（YYYY-MM-DD） |
| dateTo       | query |     | date | 10 | 作成日終了（YYYY-MM-DD） |
| cashierId    | query |     | string | 20 | 担当レジ係ID |
| customerId   | query |     | string | 20 | 顧客ID |
| orderId      | query |     | string | 30 | 仮販売ID検索 |
| sortBy       | query |     | string | 20 | ソート項目（createdAt/orderId/totalAmount） |
| sortOrder    | query |     | string | 10 | ソート順（asc/desc） |
| limit        | query |     | number | 3  | 取得件数（デフォルト20） |
| offset       | query |     | number | 10 | 取得開始位置（デフォルト0） |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| orders       | array | - | 仮販売リスト |
| orders[].id  | string | 30 | 仮販売ID |
| orders[].status | string | 20 | 状態（pending/confirmed/cancelled/expired） |
| orders[].totalAmount | number | 10,2 | 合計金額 |
| orders[].itemCount | number | 10 | 商品点数 |
| orders[].customerName | string | 100 | 顧客名 |
| orders[].cashierName | string | 100 | 担当レジ係名 |
| orders[].createdAt | datetime | - | 作成日時 |
| orders[].expiresAt | datetime | - | 有効期限 |
| orders[].isNew | boolean | - | 新規フラグ |
| orders[].isUrgent | boolean | - | 緊急フラグ（期限間近） |
| total        | number | 10 | 総件数 |
| summary      | object | - | サマリー情報 |
| summary.pendingCount | number | 10 | 未処理件数 |
| summary.expiringSoonCount | number | 10 | 期限間近件数 |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 400    | 日付の形式が正しくありません | 日付形式エラー |
| 400    | ソート項目が無効です | sortBy値不正 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - 日付形式チェック（YYYY-MM-DD）
    - status, sortBy, sortOrderの値チェック
    - limit, offsetの数値チェック
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương関/DB):
    - cashierIdが指定されている場合、usersテーブルで存在チェック
    - 期限切れ注文の自動ステータス更新（expired）
- 3. 業務処理 (Xử lý nghiệp vụ):
    - provisional_ordersテーブルから条件に合う注文を検索
    - users, customersテーブルと結合して名前取得
    - 新規フラグ判定（作成から30分以内）
    - 緊急フラグ判定（期限まで2時間以内）
    - ソート・ページング処理
    - サマリー情報計算
- 4. レスポンス生成 (Trả kết quả):
    - 仮販売リスト・サマリー情報を含むJSONレスポンス返却

#### 6. 備考 (Ghi chú)
- 期限切れ注文は自動的にexpiredステータスに更新
- 新規・緊急注文のハイライト機能

### API 2: 仮販売詳細取得API

---
**API ID**: PROV004
**API名**: 仮販売詳細取得
**エンドポイント**: /api/provisional-orders/{orderId}
**メソッド**: GET

#### 1. 機能概要 (Tóm tắt chức năng)
- 指定された仮販売の詳細情報を取得する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| orderId      | path | ○   | string | 30 | 仮販売ID |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| order        | object | - | 仮販売詳細 |
| order.id     | string | 30 | 仮販売ID |
| order.status | string | 20 | 状態 |
| order.totalAmount | number | 10,2 | 合計金額 |
| order.customerInfo | object | - | 顧客情報 |
| order.deliveryOption | object | - | 配送オプション |
| order.installationOption | object | - | 設置オプション |
| order.note   | string | 1000 | 備考 |
| order.createdAt | datetime | - | 作成日時 |
| order.expiresAt | datetime | - | 有効期限 |
| items        | array | - | 商品明細 |
| items[].productId | string | 20 | 商品ID |
| items[].productName | string | 255 | 商品名 |
| items[].sku  | string | 50 | SKU |
| items[].quantity | number | 10 | 数量 |
| items[].unitPrice | number | 10,2 | 単価 |
| items[].discount | number | 10,2 | 割引額 |
| items[].subtotal | number | 10,2 | 小計 |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 404    | 指定された仮販売が見つかりません | orderId不正 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - orderIdの必須チェック・形式チェック
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương関/DB):
    - provisional_ordersテーブルでorderId存在チェック
    - 不正な場合：404エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - 仮販売ヘッダ情報取得（provisional_ordersテーブル）
    - 商品明細取得（provisional_order_items, productsテーブル結合）
    - 顧客情報・配送・設置オプション取得
    - 小計・合計金額計算
- 4. レスポンス生成 (Trả kết quả):
    - 仮販売詳細・商品明細を含むJSONレスポンス返却

#### 6. 備考 (Ghi chú)
- 削除済み商品も履歴として表示

### API 3: 仮販売確定API

---
**API ID**: PROV005
**API名**: 仮販売確定
**エンドポイント**: /api/provisional-orders/{orderId}/confirm
**メソッド**: PUT

#### 1. 機能概要 (Tóm tắt chức năng)
- 仮販売を確定し、正式注文として処理する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| orderId      | path | ○   | string | 30 | 仮販売ID |
| cashierId    | body | ○   | string | 20 | 確定作業者ID |
| note         | body |     | string | 500 | 確定時備考 |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| success      | boolean | - | 確定成功/失敗 |
| confirmedOrderId | string | 30 | 確定後注文ID |
| message      | string | 255 | メッセージ |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 400    | 既に確定済みの注文です | 状態不正 |
| 400    | 期限切れの注文です | 期限切れ |
| 404    | 指定された仮販売が見つかりません | orderId不正 |
| 409    | 在庫が不足しています | 在庫不足 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - orderId, cashierIdの必須チェック
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương関/DB):
    - provisional_ordersテーブルでorderId・状態チェック
    - usersテーブルでcashierId存在チェック
    - 期限・状態チェック（pending以外はエラー）
    - 在庫数確認（stock_reservationsテーブル）
    - 不正な場合：400/404/409エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - 正式注文作成（ordersテーブル）
    - 注文明細作成（order_itemsテーブル）
    - 在庫予約を正式消費に変更（stocksテーブル更新）
    - 仮販売状態をconfirmedに更新
    - 確定履歴記録（order_history_logsテーブル）
- 4. レスポンス生成 (Trả kết quả):
    - 確定成功：正式注文ID返却

#### 6. 備考 (Ghi chú)
- トランザクション処理必須
- 在庫消費処理は原子性保証

### API 4: 仮販売取消API

---
**API ID**: PROV006
**API名**: 仮販売取消
**エンドポイント**: /api/provisional-orders/{orderId}/cancel
**メソッド**: PUT

#### 1. 機能概要 (Tóm tắt chức năng)
- 仮販売を取消し、在庫予約を解除する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| orderId      | path | ○   | string | 30 | 仮販売ID |
| cashierId    | body | ○   | string | 20 | 取消作業者ID |
| reason       | body | ○   | string | 500 | 取消理由 |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| success      | boolean | - | 取消成功/失敗 |
| message      | string | 255 | メッセージ |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 400    | 既に処理済みの注文です | 状態不正 |
| 404    | 指定された仮販売が見つかりません | orderId不正 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - orderId, cashierId, reasonの必須チェック
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương관/DB):
    - provisional_ordersテーブルでorderId・状態チェック
    - usersテーブルでcashierId存在チェック
    - 状態チェック（pending以外はエラー）
    - 不正な場合：400/404エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - 在庫予約解除（stock_reservationsテーブル削除）
    - 仮販売状態をcancelledに更新
    - 取消履歴記録（cancellation_logsテーブル）
    - 取消理由保存
- 4. レスポンス生成 (Trả kết quả):
    - 取消成功メッセージ返却

#### 6. 備考 (Ghi chú)
- 在庫予約解除は即座実行
- 取消理由は必須記録

---

## 関連テーブル

- **provisional_orders**: 仮販売ヘッダ
- **provisional_order_items**: 仮販売明細
- **orders**: 正式注文ヘッダ
- **order_items**: 正式注文明細
- **products**: 商品マスタ
- **stocks**: 在庫情報
- **stock_reservations**: 在庫予約
- **users**: ユーザー情報（レジ係等）
- **customers**: 顧客情報
- **order_history_logs**: 注文履歴ログ
- **cancellation_logs**: 取消履歴ログ

## 備考

- 新規・緊急注文のハイライト表示機能
- 期限切れ注文の自動ステータス更新
- 在庫予約・消費の原子性保証
- 確定・取消履歴の完全記録