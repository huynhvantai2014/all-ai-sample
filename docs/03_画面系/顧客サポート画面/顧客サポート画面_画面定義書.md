# 画面定義書 - 顧客サポート画面

---

**画面名**：顧客サポート画面
**画面ID**：SRC0009
**画面物理名**：customer_support
**URL**：/customer_support

## 画面で使用するAPI一覧

### API 1: 顧客対応履歴取得API

---
**API ID**: SUP001
**API名**: 顧客対応履歴取得
**エンドポイント**: /api/customer-support/history
**メソッド**: GET

#### 1. 機能概要 (Tóm tắt chức năng)
- 顧客対応履歴を検索・取得し、一覧表示用に整形する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| customerId   | query |     | string | 20 | 顧客ID |
| status       | query |     | string | 20 | 対応状況（open/in_progress/resolved/closed） |
| dateFrom     | query |     | date | 10 | 対応日開始 |
| dateTo       | query |     | date | 10 | 対応日終了 |
| assigneeId   | query |     | string | 20 | 担当者ID |
| priority     | query |     | string | 10 | 優先度（high/medium/low） |
| limit        | query |     | number | 3  | 取得件数 |
| offset       | query |     | number | 10 | 取得開始位置 |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| cases        | array | - | 対応履歴リスト |
| cases[].id   | string | 20 | ケースID |
| cases[].customerId | string | 20 | 顧客ID |
| cases[].customerName | string | 100 | 顧客名 |
| cases[].subject | string | 255 | 件名 |
| cases[].status | string | 20 | 対応状況 |
| cases[].priority | string | 10 | 優先度 |
| cases[].assigneeName | string | 100 | 担当者名 |
| cases[].createdAt | datetime | - | 作成日時 |
| cases[].updatedAt | datetime | - | 更新日時 |
| total        | number | 10 | 総件数 |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 400    | 検索条件が正しくありません | パラメータ不正 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - パラメータ形式チェック
- 2. 相関バリデーション (Validate tương関/DB):
    - 顧客・担当者存在チェック
- 3. 業務処理 (Xử lý nghiệp vụ):
    - support_casesテーブルから条件検索
    - customers, usersテーブルと結合
    - ソート・ページング処理
- 4. レスポンス生成 (Trả kết quả):
    - 対応履歴リスト・総件数返却

#### 6. 備考 (Ghi chú)
- 優先度による緊急度表示

### API 2: 顧客対応詳細取得API

---
**API ID**: SUP002
**API名**: 顧客対応詳細取得
**エンドポイント**: /api/customer-support/cases/{caseId}
**メソッド**: GET

#### 1. 機能概要 (Tóm tắt chức năng)
- 指定ケースの詳細情報と対応履歴を取得する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| caseId       | path | ○   | string | 20 | ケースID |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| case         | object | - | ケース詳細 |
| case.id      | string | 20 | ケースID |
| case.subject | string | 255 | 件名 |
| case.description | string | 2000 | 詳細説明 |
| case.status  | string | 20 | 対応状況 |
| case.priority | string | 10 | 優先度 |
| case.customer | object | - | 顧客情報 |
| case.assignee | object | - | 担当者情報 |
| activities   | array | - | 対応履歴 |
| activities[].id | string | 20 | 活動ID |
| activities[].type | string | 20 | 活動種別（call/email/note） |
| activities[].content | string | 2000 | 内容 |
| activities[].userId | string | 20 | 実行者ID |
| activities[].createdAt | datetime | - | 実行日時 |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 404    | ケースが見つかりません | caseId不正 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - caseIdの必須チェック
- 2. 相関バリデーション (Validate tương关/DB):
    - support_casesテーブルでcaseId存在チェック
- 3. 業務処理 (Xử lý nghiệp vụ):
    - ケース詳細情報取得
    - 対応履歴取得（case_activitiesテーブル）
    - 関連情報結合
- 4. レスポンス生成 (Trả kết quả):
    - ケース詳細・対応履歴返却

#### 6. 備考 (Ghi chú)
- 対応履歴の時系列表示

### API 3: 対応履歴エクスポートAPI

---
**API ID**: SUP003
**API名**: 対応履歴エクスポート
**エンドポイント**: /api/customer-support/export
**メソッド**: POST

#### 1. 機能概要 (Tóm tắt chức năng)
- 顧客対応履歴をCSV/Excel形式でエクスポートする

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| dateFrom     | body | ○   | date | 10 | 対応日開始 |
| dateTo       | body | ○   | date | 10 | 対応日終了 |
| format       | body | ○   | string | 10 | 出力形式（csv/excel） |
| includeDetails | body |   | boolean | - | 詳細含む |
| filterStatus | body |     | array | - | 対応状況フィルタ |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| success      | boolean | - | エクスポート成功/失敗 |
| downloadUrl  | string | 500 | ダウンロードURL |
| fileSize     | number | 10 | ファイルサイズ |
| expiresAt    | datetime | - | URL有効期限 |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 400    | 無効な出力形式です | format値不正 |
| 500    | エクスポートに失敗しました | ファイル生成エラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - 必須項目・形式チェック
- 2. 相関バリデーション (Validate tương关/DB):
    - データ存在チェック
- 3. 業務処理 (Xử lý nghiệp vụ):
    - 対応履歴データ取得・整形
    - CSV/Excelファイル生成
    - 一時保存・URL生成
- 4. レスポンス生成 (Trả kết quả):
    - ダウンロードURL返却

#### 6. 備考 (Ghi chú)
- ファイル一時保存（24時間）

---

## 関連テーブル

- **support_cases**: 顧客対応ケース
- **case_activities**: 対応履歴・活動記録
- **customers**: 顧客情報
- **users**: ユーザー情報（担当者）