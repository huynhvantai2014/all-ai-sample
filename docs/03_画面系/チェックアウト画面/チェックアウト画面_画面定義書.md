# 画面定義書 - チェックアウト画面

---

**画面名**：チェックアウト画面
**画面ID**：SRC0004
**画面物理名**：checkout
**URL**：/checkout

## 画面で使用するAPI一覧

### API 1: チェックアウトセッション開始API

---
**API ID**: CHKOUT001
**API名**: チェックアウトセッション開始
**エンドポイント**: /api/checkout/start
**メソッド**: POST

#### 1. 機能概要 (Tóm tắt chức năng)
- 新しいチェックアウトセッションを開始し、カート情報を初期化する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| orderId      | body |     | string | 30 | 仮販売ID（仮販売からの場合） |
| cashierId    | body | ○   | string | 20 | レジ担当者ID |
| terminalId   | body | ○   | string | 20 | POS端末ID |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| sessionId    | string | 50 | チェックアウトセッションID |
| cartItems    | array | - | カート商品リスト（仮販売からの場合） |
| cartItems[].productId | string | 20 | 商品ID |
| cartItems[].productName | string | 255 | 商品名 |
| cartItems[].quantity | number | 10 | 数量 |
| cartItems[].unitPrice | number | 10,2 | 単価 |
| cartItems[].discount | number | 10,2 | 割引額 |
| subtotal     | number | 10,2 | 小計 |
| taxAmount    | number | 10,2 | 消費税額 |
| totalAmount  | number | 10,2 | 合計金額 |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 400    | 必須項目が入力されていません | パラメータ不足 |
| 404    | 指定された仮販売が見つかりません | orderId不正 |
| 409    | 既にアクティブなセッションがあります | 重複セッション |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - cashierId, terminalIdの必須チェック
    - orderIdが指定されている場合の形式チェック
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương関/DB):
    - usersテーブルでcashierId存在チェック
    - terminalsテーブルでterminalId存在・有効性チェック
    - orderIdが指定されている場合、provisional_ordersテーブルで存在・状態チェック
    - アクティブなセッション重複チェック（checkout_sessionsテーブル）
    - 不正な場合：400/404/409エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - セッションID生成（UUID）
    - checkout_sessionsテーブルに新規セッション登録
    - orderIdが指定されている場合：
      - 仮販売商品をカートに追加（cart_itemsテーブル）
      - 小計・税額・合計金額計算
    - 空カートの場合：初期値設定
- 4. レスポンス生成 (Trả kết quả):
    - セッションID・カート情報・金額計算結果返却

#### 6. 備考 (Ghi chú)
- セッション有効期限：30分
- 同一端末で複数セッション不可

### API 2: 商品スキャン・追加API

---
**API ID**: CHKOUT002
**API名**: 商品スキャン・追加
**エンドポイント**: /api/checkout/{sessionId}/add-item
**メソッド**: POST

#### 1. 機能概要 (Tóm tắt chức năng)
- バーコード・JANスキャンまたは手動で商品をカートに追加する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| sessionId    | path | ○   | string | 50 | セッションID |
| productId    | body |     | string | 20 | 商品ID（手動追加時） |
| barcode      | body |     | string | 20 | バーコード・JAN（スキャン時） |
| quantity     | body |     | number | 10 | 数量（デフォルト1） |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| success      | boolean | - | 追加成功/失敗 |
| item         | object | - | 追加された商品情報 |
| item.productId | string | 20 | 商品ID |
| item.productName | string | 255 | 商品名 |
| item.sku     | string | 50 | SKU |
| item.quantity | number | 10 | 数量 |
| item.unitPrice | number | 10,2 | 単価 |
| item.subtotal | number | 10,2 | 小計 |
| cartSummary  | object | - | カート合計情報 |
| cartSummary.itemCount | number | 10 | 商品点数 |
| cartSummary.subtotal | number | 10,2 | 小計 |
| cartSummary.taxAmount | number | 10,2 | 消費税額 |
| cartSummary.totalAmount | number | 10,2 | 合計金額 |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 400    | 商品IDまたはバーコードが必要です | パラメータ不足 |
| 404    | セッションが見つかりません | sessionId不正 |
| 404    | 商品が見つかりません | 商品未登録 |
| 409    | 在庫が不足しています | 在庫不足 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - sessionIdの必須チェック
    - productIdまたはbarcodeのいずれか必須チェック
    - quantityの正数チェック
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương关/DB):
    - checkout_sessionsテーブルでsessionId存在・有効期限チェック
    - barcodeが指定されている場合：productsテーブルでjanCode照合
    - productIdが指定されている場合：productsテーブルで存在チェック
    - stocksテーブルで在庫数チェック
    - 不正な場合：404/409エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - 商品情報取得（products, tax_ratesテーブル結合）
    - 既存カートアイテムチェック（同一商品の場合は数量加算）
    - cart_itemsテーブルに追加・更新
    - 小計計算（数量 × 単価）
    - 税額計算（商品別税率適用）
    - カート合計金額再計算
    - セッション最終更新時刻更新
- 4. レスポンス生成 (Trả kết quả):
    - 追加商品情報・カート合計情報返却

#### 6. 備考 (Ghi chú)
- 同一商品は数量加算で処理
- 軽減税率対応（商品別税率設定）

### API 3: 商品数量・割引調整API

---
**API ID**: CHKOUT003
**API名**: 商品数量・割引調整
**エンドポイント**: /api/checkout/{sessionId}/update-item
**メソッド**: PUT

#### 1. 機能概要 (Tóm tắt chức năng)
- カート内商品の数量・割引額を調整し、金額を再計算する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| sessionId    | path | ○   | string | 50 | セッションID |
| itemId       | path | ○   | string | 20 | カートアイテムID |
| quantity     | body |     | number | 10 | 新しい数量 |
| discount     | body |     | number | 10,2 | 割引額 |
| discountType | body |     | string | 10 | 割引種別（amount/percent） |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| success      | boolean | - | 更新成功/失敗 |
| item         | object | - | 更新された商品情報 |
| item.quantity | number | 10 | 数量 |
| item.unitPrice | number | 10,2 | 単価 |
| item.discount | number | 10,2 | 割引額 |
| item.subtotal | number | 10,2 | 小計 |
| cartSummary  | object | - | カート合計情報 |
| cartSummary.subtotal | number | 10,2 | 小計 |
| cartSummary.discountTotal | number | 10,2 | 割引合計 |
| cartSummary.taxAmount | number | 10,2 | 消費税額 |
| cartSummary.totalAmount | number | 10,2 | 合計金額 |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 400    | 数量は1以上で入力してください | quantity値不正 |
| 400    | 割引額が商品金額を超えています | discount値不正 |
| 404    | セッションまたはアイテムが見つかりません | ID不正 |
| 409    | 在庫が不足しています | 在庫不足 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - sessionId, itemIdの必須チェック
    - quantityの正数チェック（1以上）
    - discountの非負数チェック
    - discountTypeの値チェック（amount/percent）
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương関/DB):
    - checkout_sessionsテーブルでsessionId存在・有効期限チェック
    - cart_itemsテーブルでitemId存在チェック
    - stocksテーブルで在庫数チェック（数量増加時）
    - 割引額妥当性チェック（商品金額以下）
    - 不正な場合：404/409エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - cart_itemsテーブルの数量・割引更新
    - 小計再計算（数量 × 単価 - 割引）
    - パーセント割引の場合：割引額 = 商品金額 × 割引率
    - 税額再計算（割引後金額に対して）
    - カート全体の合計金額再計算
    - セッション最終更新時刻更新
- 4. レスポンス生成 (Trả kết quả):
    - 更新商品情報・カート合計情報返却

#### 6. 備考 (Ghi chú)
- 数量0指定で商品削除
- 割引上限チェック機能

### API 4: 商品削除API

---
**API ID**: CHKOUT004
**API名**: 商品削除
**エンドポイント**: /api/checkout/{sessionId}/remove-item/{itemId}
**メソッド**: DELETE

#### 1. 機能概要 (Tóm tắt chức năng)
- カートから指定商品を削除し、金額を再計算する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| sessionId    | path | ○   | string | 50 | セッションID |
| itemId       | path | ○   | string | 20 | カートアイテムID |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| success      | boolean | - | 削除成功/失敗 |
| cartSummary  | object | - | カート合計情報 |
| cartSummary.itemCount | number | 10 | 商品点数 |
| cartSummary.subtotal | number | 10,2 | 小計 |
| cartSummary.taxAmount | number | 10,2 | 消費税額 |
| cartSummary.totalAmount | number | 10,2 | 合計金額 |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 404    | セッションまたはアイテムが見つかりません | ID不正 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - sessionId, itemIdの必須チェック
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương关/DB):
    - checkout_sessionsテーブルでsessionId存在・有効期限チェック
    - cart_itemsテーブルでitemId存在チェック
    - 不正な場合：404エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - cart_itemsテーブルから該当商品削除
    - カート全体の合計金額再計算
    - セッション最終更新時刻更新
- 4. レスポンス生成 (Trả kết quả):
    - 削除成功・カート合計情報返却

#### 6. 備考 (Ghi chú)
- 削除後カート空の場合は合計0

### API 5: カート情報取得API

---
**API ID**: CHKOUT005
**API名**: カート情報取得
**エンドポイント**: /api/checkout/{sessionId}/cart
**メソッド**: GET

#### 1. 機能概要 (Tóm tắt chức năng)
- 現在のカート内容と金額情報を取得する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| sessionId    | path | ○   | string | 50 | セッションID |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| sessionId    | string | 50 | セッションID |
| items        | array | - | カート商品リスト |
| items[].id   | string | 20 | カートアイテムID |
| items[].productId | string | 20 | 商品ID |
| items[].productName | string | 255 | 商品名 |
| items[].sku  | string | 50 | SKU |
| items[].quantity | number | 10 | 数量 |
| items[].unitPrice | number | 10,2 | 単価 |
| items[].discount | number | 10,2 | 割引額 |
| items[].taxRate | number | 5,3 | 税率 |
| items[].subtotal | number | 10,2 | 小計 |
| summary      | object | - | カート合計情報 |
| summary.itemCount | number | 10 | 商品点数 |
| summary.subtotal | number | 10,2 | 小計 |
| summary.discountTotal | number | 10,2 | 割引合計 |
| summary.taxAmount | number | 10,2 | 消費税額 |
| summary.totalAmount | number | 10,2 | 合計金額 |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 404    | セッションが見つかりません | sessionId不正 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - sessionIdの必須チェック
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương관/DB):
    - checkout_sessionsテーブルでsessionId存在・有効期限チェック
    - 不正な場合：404エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - cart_itemsテーブルからセッションのアイテム取得
    - productsテーブルと結合して商品詳細取得
    - 合計金額・税額計算
- 4. レスポンス生成 (Trả kết quả):
    - カート商品リスト・合計情報返却

#### 6. 備考 (Ghi chú)
- 空カートでも正常応答
- 税額は商品別税率で個別計算

---

## 関連テーブル

- **checkout_sessions**: チェックアウトセッション管理
- **cart_items**: カート商品アイテム
- **products**: 商品マスタ
- **stocks**: 在庫情報
- **tax_rates**: 税率マスタ
- **users**: ユーザー情報（レジ係）
- **terminals**: POS端末情報
- **provisional_orders**: 仮販売情報

## 備考

- バーコード・JANスキャン対応
- 軽減税率対応（商品別税率）
- リアルタイム金額計算
- セッションタイムアウト管理（30分）
- 在庫チェック機能