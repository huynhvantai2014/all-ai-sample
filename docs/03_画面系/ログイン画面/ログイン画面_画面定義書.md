# 画面定義書 - ログイン画面

---

**画面名**：ログイン画面
**画面ID**：SRC0001  
**画面物理名**：login
**URL**：/login

## 画面で使用するAPI一覧

### API 1: ユーザー認証API

---
**API ID**: AUTH001
**API名**: ユーザー認証
**エンドポイント**: /api/auth/login
**メソッド**: POST

#### 1. 機能概要 (Tóm tắt chức năng)
- POSシステムのユーザー認証を行い、セッションを確立する
- ユーザー名・パスワード検証とログイン履歴の記録

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| username     | body | ○    | string | 50 | ユーザー名 |
| password     | body | ○    | string | 255 | パスワード（暗号化） |
| terminalId   | body | ○    | string | 20 | 端末ID |
| rememberDevice | body |    | boolean | - | デバイス記憶オプション |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| success      | boolean | - | 認証成功/失敗 |
| token        | string | 255 | セッショントークン |
| user         | object | - | ユーザー情報オブジェクト |
| user.id      | string | 20 | ユーザーID |
| user.name    | string | 100 | ユーザー名 |
| user.role    | string | 50 | ユーザーロール |
| user.storeId | string | 20 | 店舗ID |
| user.storeName | string | 100 | 店舗名 |
| message      | string | 255 | メッセージ |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 401    | ユーザー名またはパスワードが正しくありません | 認証失敗 |
| 403    | アカウントがロックされています | アカウントロック |
| 400    | 必須項目が入力されていません | パラメータ不足 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - username, password, terminalIdの必須チェック
    - 文字数・形式チェック
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương quan/DB):
    - usersテーブルでユーザー存在チェック
    - passwordハッシュ値照合
    - アカウントロック状態チェック（login_attemptsテーブル）
    - 端末ID有効性チェック（terminalsテーブル）
    - 認証失敗の場合：401または403エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - 認証成功時：セッショントークン生成・保存（user_sessionsテーブル）
    - ログイン履歴記録（login_historyテーブル：timestamp, userID, terminalID, IP）
    - ユーザー情報取得（users, stores, rolesテーブル結合）
    - 失敗回数リセット（login_attemptsテーブル）
- 4. レスポンス生成 (Trả kết quả):
    - 成功：トークン、ユーザー情報を含むJSONレスポンス
    - 失敗：エラーコード・メッセージ返却

#### 6. 備考 (Ghi chú)
- パスワードはbcryptでハッシュ化
- セッション有効期限：8時間
- 連続失敗5回でアカウント一時ロック（30分）

### API 2: ログアウトAPI

---
**API ID**: AUTH002
**API名**: ログアウト
**エンドポイント**: /api/auth/logout
**メソッド**: POST

#### 1. 機能概要 (Tóm tắt chức năng)
- ユーザーセッションを無効化し、ログアウト履歴を記録する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| token        | header | ○   | string | 255 | セッショントークン |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| success      | boolean | - | ログアウト成功/失敗 |
| message      | string | 255 | メッセージ |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 401    | 無効なトークンです | トークン不正 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - トークンの必須チェック・形式チェック
    - 不正な場合：401エラー返却
- 2. 相関バリデーション (Validate tương関/DB):
    - user_sessionsテーブルでトークン有効性チェック
    - セッション期限チェック
    - 無効な場合：401エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - セッション無効化（user_sessionsテーブル削除または無効フラグ）
    - ログアウト履歴記録（login_historyテーブル：logout_timestamp更新）
- 4. レスポンス生成 (Trả kết quả):
    - 成功：ログアウト完了メッセージ返却

#### 6. 備考 (Ghi chú)
- トークンは一度無効化されると再利用不可

### API 3: セッション確認API

---
**API ID**: AUTH003
**API名**: セッション確認
**エンドポイント**: /api/auth/verify-session
**メソッド**: GET

#### 1. 機能概要 (Tóm tắt chức năng)
- 現在のセッション有効性を確認し、ユーザー情報を取得する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| token        | header | ○   | string | 255 | セッショントークン |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| valid        | boolean | - | セッション有効/無効 |
| user         | object | - | ユーザー情報オブジェクト |
| user.id      | string | 20 | ユーザーID |
| user.name    | string | 100 | ユーザー名 |
| user.role    | string | 50 | ユーザーロール |
| expiresAt    | datetime | - | セッション期限 |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 401    | セッションが無効です | トークン期限切れ・不正 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - トークンの必須チェック・形式チェック
    - 不正な場合：401エラー返却
- 2. 相関バリデーション (Validate tương関/DB):
    - user_sessionsテーブルでトークン存在・有効期限チェック
    - 無効な場合：401エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - セッション期限延長（オプション）
    - ユーザー情報取得（users, rolesテーブル結合）
- 4. レスポンス生成 (Trả kết quả):
    - 有効：ユーザー情報・セッション期限返却
    - 無効：401エラー返却

#### 6. 備考 (Ghi chú)
- セッション自動延長機能あり（アクセス時に期限延長）

---

## 関連テーブル

- **users**: ユーザー基本情報
- **user_sessions**: セッション管理
- **login_history**: ログイン/ログアウト履歴
- **login_attempts**: ログイン試行回数管理
- **stores**: 店舗情報
- **roles**: ユーザーロール定義
- **terminals**: 端末情報

## 備考

- すべてのAPIはHTTPS必須
- セッション管理はJWT形式を推奨
- ログイン履歴は監査・セキュリティ分析用途で長期保存
