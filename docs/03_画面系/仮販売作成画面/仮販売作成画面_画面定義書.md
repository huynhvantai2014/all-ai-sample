# 画面定義書 - 仮販売作成画面

---

**画面名**：仮販売作成画面
**画面ID**：SRC0002
**画面物理名**：provisional_order
**URL**：/provisional_order

## 画面で使用するAPI一覧

### API 1: 商品検索API

---
**API ID**: PROD001
**API名**: 商品検索
**エンドポイント**: /api/products/search
**メソッド**: GET

#### 1. 機能概要 (Tóm tắt chức năng)
- 商品名・バーコード・JANコードで商品を検索し、一覧を返す

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| keyword      | query | ○   | string | 100 | 検索キーワード（商品名・バーコード・JAN） |
| limit        | query |     | number | 3   | 取得件数（デフォルト20） |
| offset       | query |     | number | 10  | 取得開始位置（デフォルト0） |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| products     | array | - | 商品リスト |
| products[].id | string | 20 | 商品ID |
| products[].name | string | 255 | 商品名 |
| products[].sku | string | 50 | SKU |
| products[].janCode | string | 20 | JANコード |
| products[].price | number | 10,2 | 単価 |
| products[].stock | number | 10 | 在庫数 |
| products[].imageUrl | string | 500 | 商品画像URL |
| total        | number | 10 | 総件数 |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 400    | 検索キーワードが入力されていません | keyword未入力 |
| 404    | 該当する商品が見つかりません | 検索結果0件 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - keywordの必須チェック・文字数チェック
    - limit, offsetの数値チェック
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương関/DB):
    - productsテーブルでキーワード検索（name, sku, janCode に対してLIKE検索）
    - 在庫情報チェック（stocksテーブル結合）
    - 検索結果0件の場合：404エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - 検索結果をlimit/offsetでページング
    - 商品画像URL生成
    - 在庫数取得・計算
- 4. レスポンス生成 (Trả kết quả):
    - 商品リスト・総件数を含むJSONレスポンス返却

#### 6. 備考 (Ghi chú)
- 部分一致検索対応
- 在庫0の商品も表示（警告表示）

### API 2: 仮販売作成API

---
**API ID**: PROV001
**API名**: 仮販売作成
**エンドポイント**: /api/provisional-orders
**メソッド**: POST

#### 1. 機能概要 (Tóm tắt chức năng)
- 仮販売データを作成し、レジ担当者へ通知する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| items        | body | ○   | array | - | 商品リスト |
| items[].productId | body | ○ | string | 20 | 商品ID |
| items[].quantity | body | ○ | number | 10 | 数量 |
| items[].unitPrice | body | ○ | number | 10,2 | 単価 |
| items[].discount | body |  | number | 10,2 | 割引額 |
| customerInfo | body |     | object | - | 顧客情報 |
| customerInfo.name | body |  | string | 100 | 顧客名 |
| customerInfo.phone | body | | string | 20 | 電話番号 |
| deliveryOption | body |   | object | - | 配送オプション |
| deliveryOption.required | body | | boolean | - | 配送要否 |
| deliveryOption.address | body | | string | 500 | 配送先住所 |
| installationOption | body | | object | - | 設置オプション |
| installationOption.required | body | | boolean | - | 設置要否 |
| note         | body |     | string | 1000 | 備考 |
| cashierId    | body |     | string | 20 | 担当レジ係ID |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| success      | boolean | - | 作成成功/失敗 |
| orderId      | string | 30 | 仮販売ID（PROV-YYYYMMDD-XXXX形式） |
| totalAmount  | number | 10,2 | 合計金額 |
| expiresAt    | datetime | - | 有効期限 |
| message      | string | 255 | メッセージ |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 400    | 商品が選択されていません | items配列が空 |
| 400    | 在庫が不足している商品があります | 在庫不足 |
| 404    | 指定された商品が見つかりません | productId不正 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - items配列の必須チェック・各アイテムのバリデーション
    - 数量・単価の数値チェック、正数チェック
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương関/DB):
    - productsテーブルで商品存在チェック
    - stocksテーブルで在庫数チェック
    - cashierIdが指定されている場合、usersテーブルで存在チェック
    - 不正な場合：400または404エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - 仮販売ID生成（PROV-YYYYMMDD-XXXX形式）
    - 合計金額計算（小計 - 割引）
    - 有効期限設定（現在時刻+24時間）
    - provisional_ordersテーブルに保存
    - provisional_order_itemsテーブルに明細保存
    - 在庫予約処理（stock_reservationsテーブル）
    - レジ担当者への通知送信（notificationsテーブル）
- 4. レスポンス生成 (Trả kết quả):
    - 作成成功：仮販売ID・合計金額・有効期限返却

#### 6. 備考 (Ghi chú)
- 在庫は仮予約状態（確定まで他注文で使用不可）
- 24時間後自動失効

### API 3: 仮販売番号生成API

---
**API ID**: PROV002
**API名**: 仮販売番号生成
**エンドポイント**: /api/provisional-orders/generate-id
**メソッド**: GET

#### 1. 機能概要 (Tóm tắt chức năng)
- 一意な仮販売番号を生成する（PROV-YYYYMMDD-XXXX形式）

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| なし         | -    | -   | -  | -   | - |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| orderId      | string | 30 | 生成された仮販売ID |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - パラメータなし
- 2. 相関バリデーション (Validate tương関/DB):
    - 現在日付でのシーケンス番号取得（order_sequencesテーブル）
- 3. 業務処理 (Xử lý nghiệp vụ):
    - 現在日付取得（YYYYMMDD形式）
    - シーケンス番号インクリメント（4桁ゼロパディング）
    - 仮販売ID生成：PROV-{YYYYMMDD}-{XXXX}
    - 重複チェック（provisional_ordersテーブル）
    - 重複時は再生成
- 4. レスポンス生成 (Trả kết quả):
    - 生成された仮販売ID返却

#### 6. 備考 (Ghi chú)
- 日付変更時にシーケンス番号リセット
- 重複防止機能あり

### API 4: バーコード読み取りAPI

---
**API ID**: PROD002
**API名**: バーコード商品取得
**エンドポイント**: /api/products/barcode/{code}
**メソッド**: GET

#### 1. 機能概要 (Tóm tắt chức năng)
- バーコード・JANコードから商品情報を取得する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| code         | path | ○   | string | 20 | バーコード・JANコード |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| product      | object | - | 商品情報 |
| product.id   | string | 20 | 商品ID |
| product.name | string | 255 | 商品名 |
| product.sku  | string | 50 | SKU |
| product.janCode | string | 20 | JANコード |
| product.price | number | 10,2 | 単価 |
| product.stock | number | 10 | 在庫数 |
| product.imageUrl | string | 500 | 商品画像URL |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 400    | バーコードが正しくありません | code形式不正 |
| 404    | 該当する商品が見つかりません | 商品未登録 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - codeの必須チェック・文字数チェック
    - バーコード形式チェック（数字のみ、桁数チェック）
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương关/DB):
    - productsテーブルでjanCodeまたはskuと照合
    - 商品未登録の場合：404エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - 商品情報取得（products, stocksテーブル結合）
    - 在庫数取得・計算
    - 商品画像URL生成
- 4. レスポンス生成 (Trả kết quả):
    - 商品情報を含むJSONレスポンス返却

#### 6. 備考 (Ghi chú)
- JAN13・JAN8・EAN対応
- 在庫0でも商品情報表示

---

## 関連テーブル

- **products**: 商品マスタ
- **stocks**: 在庫情報
- **provisional_orders**: 仮販売ヘッダ
- **provisional_order_items**: 仮販売明細
- **stock_reservations**: 在庫予約
- **order_sequences**: 注文番号シーケンス
- **notifications**: 通知管理
- **users**: ユーザー情報（レジ係等）

## 備考

- 仮販売は24時間有効
- 在庫は仮予約状態で管理
- バーコードスキャナー連携機能あり
- レジ担当者への即座通知機能