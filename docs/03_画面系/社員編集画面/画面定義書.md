# 画面定義書
## 社員編集画面 (Employee Edit Screen)

### 画面ID: SRC0004
### 最終更新日: 2025年10月30日

---

## 1. 画面概要

### 1.1 画面名
**社員編集画面 (Employee Edit)**

### 1.2 機能概要
既存社員情報の編集・更新機能を提供。入力値検証、重複チェック、プレビュー機能を含む包括的な編集環境。

### 1.3 画面種別
- **編集画面**
- **フォーム入力画面**

### 1.4 アクセス権限
- **管理者 (admin)**: 全項目編集可能
- **マネージャー (manager)**: 一部項目編集可能
- **一般ユーザー (user)**: アクセス不可

---

## 2. 画面レイアウト

### 2.1 画面構成
```
┌─────────────────────────────────────────────────┐
│ ヘッダー: 社員編集 + ナビゲーション              │
├─────────────────────────────────────────────────┤
│ パンくずリスト                                  │
│ ホーム > 社員一覧 > 田中太郎 > 編集              │
├─────────────────────────────────────────────────┤
│ フォームエリア                                  │
│ ┌─────────────────────────────────────────┐     │
│ │ 基本情報                               │     │
│ │ 社員ID      : [EMP001    ] (変更不可) │     │
│ │ 氏名        : [田中太郎   ] *          │     │
│ │ メール      : [tanaka@...] *          │     │
│ │ 電話番号    : [090-1234- ] △          │     │
│ │ 部門        : [開発部 ▼  ] *          │     │
│ │ 役職        : [エンジニア ] *          │     │
│ │ ステータス  : [稼働中 ▼  ] *          │     │
│ │ 入社日      : [2023/04/01] *          │     │
│ └─────────────────────────────────────────┘     │
├─────────────────────────────────────────────────┤
│ スキル・専門性                                  │
│ ┌─────────────────────────────────────────┐     │
│ │ [JavaScript] [×] [Python] [×]          │     │
│ │ [React] [×] [+新規追加]                │     │
│ └─────────────────────────────────────────┘     │
├─────────────────────────────────────────────────┤
│ アクション                                      │
│ [キャンセル] [プレビュー] [保存]                │
└─────────────────────────────────────────────────┘
```

### 2.2 レスポンシブデザイン
- **デスクトップ**: 2カラムレイアウト（フォーム + プレビュー）
- **タブレット**: 1カラムレイアウト、タブ切り替え
- **モバイル**: 縦積みレイアウト、アコーディオン形式

---

## 3. 画面要素定義

### 3.1 ヘッダー部
| 要素名            | 種別         | 表示内容              | 動作                    |
|-------------------|--------------|----------------------|-------------------------|
| ページタイトル    | Typography   | "社員編集"            | なし                    |
| パンくずリスト    | Breadcrumbs  | ナビゲーションパス    | 各階層へのリンク        |

### 3.2 基本情報フォーム
| 項目名            | 種別         | 必須 | 制約                  | バリデーション          |
|-------------------|--------------|------|-----------------------|-------------------------|
| 社員ID            | TextField    | ○    | 読み取り専用          | なし                    |
| 氏名              | TextField    | ○    | 100文字以内           | 必須入力                |
| メールアドレス    | TextField    | ○    | メール形式・重複チェック | 形式・重複検証         |
| 電話番号          | TextField    | △    | 電話番号形式          | 形式検証                |
| 部門              | Select       | ○    | 選択必須              | 選択必須                |
| 役職              | TextField    | ○    | 50文字以内            | 必須入力                |
| ステータス        | Select       | ○    | 3択                   | 選択必須                |
| 入社日            | DatePicker   | ○    | 過去日のみ            | 日付形式・範囲検証      |

### 3.3 スキル・専門性
| 要素名            | 種別         | 動作                  | 制約                    |
|-------------------|--------------|----------------------|-------------------------|
| 既存スキルタグ    | Chip         | 削除ボタン付き        | 最低1つは必要           |
| 新規追加ボタン    | Button       | スキル追加モーダル    | 重複チェック            |
| スキル入力欄      | Autocomplete | 候補表示・新規入力可  | 50文字以内              |

### 3.4 アクションエリア
| 要素名            | 種別         | 動作                  | 有効条件                |
|-------------------|--------------|----------------------|-------------------------|
| キャンセルボタン  | Button       | 詳細画面へ戻る        | 常時有効                |
| プレビューボタン  | Button       | プレビューモーダル表示| フォーム有効時          |
| 保存ボタン        | Button       | 更新処理実行          | バリデーション通過時    |

---

## 4. 画面遷移

### 4.1 遷移元画面
- 社員詳細画面（SRC0003）
- 社員一覧画面（SRC0002）

### 4.2 遷移先画面
| 操作対象          | 遷移先画面          | 遷移条件              |
|-------------------|--------------------|-----------------------|
| キャンセルボタン  | 社員詳細画面 (SRC0003) | クリック             |
| 保存成功          | 社員詳細画面 (SRC0003) | 更新処理完了         |
| パンくずリスト    | 各階層画面          | クリック              |

### 4.3 確認ダイアログ
```typescript
// 未保存変更がある場合の離脱確認
const ConfirmExitDialog = ({ open, onClose, onConfirm }) => (
  <Dialog open={open} onClose={onClose}>
    <DialogTitle>変更の破棄</DialogTitle>
    <DialogContent>
      <Typography>
        変更内容が保存されていません。このまま画面を離れますか？
      </Typography>
    </DialogContent>
    <DialogActions>
      <Button onClick={onClose}>キャンセル</Button>
      <Button onClick={onConfirm} color="error">
        破棄して離脱
      </Button>
    </DialogActions>
  </Dialog>
);
```

---

## 5. API連携

### 5.1 使用API
| API ID      | 呼び出しタイミング    | 用途                    |
|-------------|----------------------|-------------------------|
| API_EMP_002 | 画面表示時            | 初期データ取得          |
| API_EMP_004 | 保存ボタンクリック時  | 社員情報更新            |
| API_AUTH_002| 画面表示時            | ユーザー権限確認        |

### 5.2 API呼び出し仕様
#### API_EMP_004: 社員情報更新
```typescript
const updateEmployee = async (employeeId: string, formData: EmployeeFormData) => {
  setIsSaving(true);
  try {
    const response = await fetch(`/api/employee/update/${employeeId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(formData)
    });
    
    const data = await response.json();
    if (data.success) {
      setSuccessMessage('社員情報を更新しました');
      // 詳細画面へリダイレクト
      router.push(`/employees/detail/${employeeId}`);
    } else {
      setError(data.message || '更新に失敗しました');
    }
  } catch (err) {
    setError('ネットワークエラーが発生しました');
  } finally {
    setIsSaving(false);
  }
};
```

---

## 6. データ構造

### 6.1 フォームState管理
```typescript
interface EmployeeFormData {
  employee_id: string; // 読み取り専用
  full_name: string;
  email: string;
  phone?: string;
  department: string;
  position: string;
  status: 'active' | 'inactive' | 'on_leave';
  skill: string[];
  join_date: string;
}

interface EmployeeEditState {
  formData: EmployeeFormData;
  originalData: EmployeeFormData;
  errors: Record<string, string>;
  isLoading: boolean;
  isSaving: boolean;
  isDirty: boolean;
  validationErrors: ValidationError[];
}
```

### 6.2 変更検知
```typescript
// フォームデータの変更を検知
const isDirty = useMemo(() => {
  return JSON.stringify(formData) !== JSON.stringify(originalData);
}, [formData, originalData]);

// 特定フィールドの変更検知
const isFieldChanged = (fieldName: keyof EmployeeFormData) => {
  return formData[fieldName] !== originalData[fieldName];
};
```

---

## 7. バリデーション機能

### 7.1 リアルタイムバリデーション
```typescript
const validationRules = {
  full_name: {
    required: true,
    maxLength: 100,
    pattern: /^[ぁ-んァ-ヶ一-龯a-zA-Z\s]+$/
  },
  email: {
    required: true,
    pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
    asyncValidation: checkEmailDuplicate
  },
  phone: {
    pattern: /^[0-9-+()]+$/,
    minLength: 10,
    maxLength: 15
  },
  department: {
    required: true,
    options: ['開発部', '営業部', '管理部', '人事部']
  },
  position: {
    required: true,
    maxLength: 50
  },
  join_date: {
    required: true,
    maxDate: new Date(),
    minDate: new Date('2000-01-01')
  }
};
```

### 7.2 重複チェック
```typescript
// メールアドレス重複チェック
const checkEmailDuplicate = async (email: string, currentEmployeeId: string) => {
  const response = await fetch('/api/employee/check-duplicate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      email, 
      excludeId: currentEmployeeId 
    })
  });
  
  const result = await response.json();
  return result.isDuplicate ? 'このメールアドレスは既に使用されています' : null;
};
```

### 7.3 バリデーションエラー表示
```typescript
const FormField = ({ name, label, error, ...props }) => (
  <TextField
    label={label}
    error={!!error}
    helperText={error}
    sx={{
      '& .MuiOutlinedInput-root': {
        '&.Mui-error': {
          '& fieldset': {
            borderColor: 'error.main',
          },
        },
      },
    }}
    {...props}
  />
);
```

---

## 8. スキル管理機能

### 8.1 スキル追加モーダル
```typescript
const SkillAddModal = ({ open, onClose, onAdd, existingSkills }) => {
  const [newSkill, setNewSkill] = useState('');
  const [skillSuggestions] = useState([
    'JavaScript', 'Python', 'React', 'Node.js',
    'TypeScript', 'MongoDB', 'AWS', '営業', '企画'
  ]);
  
  const handleAdd = () => {
    if (newSkill && !existingSkills.includes(newSkill)) {
      onAdd(newSkill);
      setNewSkill('');
      onClose();
    }
  };
  
  return (
    <Dialog open={open} onClose={onClose}>
      <DialogTitle>スキル追加</DialogTitle>
      <DialogContent>
        <Autocomplete
          options={skillSuggestions}
          freeSolo
          value={newSkill}
          onChange={(_, value) => setNewSkill(value || '')}
          renderInput={(params) => (
            <TextField
              {...params}
              label="スキル名"
              placeholder="新しいスキルを入力"
            />
          )}
        />
      </DialogContent>
      <DialogActions>
        <Button onClick={onClose}>キャンセル</Button>
        <Button onClick={handleAdd} variant="contained">
          追加
        </Button>
      </DialogActions>
    </Dialog>
  );
};
```

### 8.2 スキル削除機能
```typescript
const SkillChip = ({ skill, onDelete, canDelete }) => (
  <Chip
    label={skill}
    variant="outlined"
    onDelete={canDelete ? () => onDelete(skill) : undefined}
    sx={{ m: 0.5 }}
  />
);
```

---

## 9. プレビュー機能

### 9.1 プレビューモーダル
```typescript
const PreviewModal = ({ open, onClose, formData }) => (
  <Dialog open={open} onClose={onClose} maxWidth="md" fullWidth>
    <DialogTitle>
      変更内容プレビュー
      <IconButton onClick={onClose} sx={{ position: 'absolute', right: 8, top: 8 }}>
        <CloseIcon />
      </IconButton>
    </DialogTitle>
    <DialogContent>
      <Grid container spacing={2}>
        <Grid item xs={12} md={6}>
          <Typography variant="h6" gutterBottom>変更前</Typography>
          <EmployeePreviewCard employee={originalData} />
        </Grid>
        <Grid item xs={12} md={6}>
          <Typography variant="h6" gutterBottom>変更後</Typography>
          <EmployeePreviewCard employee={formData} />
        </Grid>
      </Grid>
      
      <Box mt={2}>
        <Typography variant="h6" gutterBottom>変更項目</Typography>
        <ChangedFieldsList original={originalData} updated={formData} />
      </Box>
    </DialogContent>
    <DialogActions>
      <Button onClick={onClose}>プレビューを閉じる</Button>
    </DialogActions>
  </Dialog>
);
```

### 9.2 変更差分表示
```typescript
const ChangedFieldsList = ({ original, updated }) => {
  const changes = Object.keys(updated).filter(key => 
    JSON.stringify(original[key]) !== JSON.stringify(updated[key])
  );
  
  return (
    <List>
      {changes.map(field => (
        <ListItem key={field}>
          <ListItemText
            primary={getFieldLabel(field)}
            secondary={
              <Box>
                <Typography component="span" color="error.main">
                  変更前: {formatFieldValue(original[field])}
                </Typography>
                <br />
                <Typography component="span" color="success.main">
                  変更後: {formatFieldValue(updated[field])}
                </Typography>
              </Box>
            }
          />
        </ListItem>
      ))}
    </List>
  );
};
```

---

## 10. エラーハンドリング

### 10.1 エラーパターン
| エラー種別        | 表示内容                    | 対処法                    |
|-------------------|----------------------------|---------------------------|
| バリデーションエラー | フィールド毎のエラーメッセージ | 入力値修正              |
| 重複エラー        | "既に使用されています"      | 別の値で再入力            |
| 権限エラー        | "編集権限がありません"      | 詳細画面へリダイレクト    |
| ネットワークエラー| "更新に失敗しました"        | 再試行ボタン表示          |

### 10.2 フォームエラー表示
```typescript
{Object.keys(errors).length > 0 && (
  <Alert severity="error" sx={{ mb: 2 }}>
    <Typography variant="h6">入力エラーがあります</Typography>
    <List dense>
      {Object.entries(errors).map(([field, message]) => (
        <ListItem key={field}>
          <ListItemText 
            primary={`${getFieldLabel(field)}: ${message}`}
          />
        </ListItem>
      ))}
    </List>
  </Alert>
)}
```

---

## 11. 自動保存機能

### 11.1 下書き保存
```typescript
// 30秒間隔で自動保存
useEffect(() => {
  if (isDirty) {
    const timer = setInterval(() => {
      saveDraft(formData);
    }, 30000);
    
    return () => clearInterval(timer);
  }
}, [formData, isDirty]);

const saveDraft = (data: EmployeeFormData) => {
  localStorage.setItem(
    `employee_edit_draft_${employeeId}`, 
    JSON.stringify(data)
  );
  setLastSaved(new Date());
};
```

### 11.2 下書き復元
```typescript
// 画面表示時に下書きチェック
useEffect(() => {
  const draftData = localStorage.getItem(`employee_edit_draft_${employeeId}`);
  if (draftData) {
    setShowDraftRestoreDialog(true);
    setDraftFormData(JSON.parse(draftData));
  }
}, [employeeId]);
```

---

## 12. パフォーマンス最適化

### 12.1 メモ化
```typescript
// フォームコンポーネントのメモ化
const MemoizedFormField = React.memo(({ name, value, onChange, error }) => (
  <TextField
    name={name}
    value={value}
    onChange={onChange}
    error={!!error}
    helperText={error}
  />
));

// バリデーション関数のメモ化
const memoizedValidation = useCallback(
  debounce((fieldName: string, value: string) => {
    validateField(fieldName, value);
  }, 300),
  []
);
```

### 12.2 遅延読み込み
```typescript
// スキル候補の遅延読み込み
const SkillAutocomplete = lazy(() => import('./SkillAutocomplete'));

// プレビューモーダルの遅延読み込み
const PreviewModal = lazy(() => import('./PreviewModal'));
```

---

## 13. アクセシビリティ

### 13.1 フォームアクセシビリティ
```typescript
<form role="form" aria-labelledby="edit-form-title">
  <Typography id="edit-form-title" variant="h4">
    社員情報編集
  </Typography>
  
  <TextField
    required
    aria-describedby="name-helper"
    label="氏名"
    error={!!errors.full_name}
    helperText={errors.full_name}
  />
  <div id="name-helper" className="sr-only">
    氏名は必須項目です。100文字以内で入力してください。
  </div>
</form>
```

### 13.2 エラーアナウンス
```typescript
// エラー発生時のスクリーンリーダー通知
useEffect(() => {
  if (Object.keys(errors).length > 0) {
    const errorMessage = `${Object.keys(errors).length}件の入力エラーがあります`;
    announceToScreenReader(errorMessage);
  }
}, [errors]);
```

---

## 14. テスト仕様

### 14.1 単体テスト
```typescript
describe('EmployeeEdit Component', () => {
  test('初期データが正しく表示される', () => {
    render(<EmployeeEdit employeeId="EMP001" />);
    expect(screen.getByDisplayValue('田中太郎')).toBeInTheDocument();
  });
  
  test('バリデーションエラーが表示される', async () => {
    render(<EmployeeEdit employeeId="EMP001" />);
    
    const nameField = screen.getByLabelText('氏名');
    fireEvent.change(nameField, { target: { value: '' } });
    fireEvent.blur(nameField);
    
    await waitFor(() => {
      expect(screen.getByText('氏名は必須項目です')).toBeInTheDocument();
    });
  });
  
  test('フォーム送信が正しく動作する', async () => {
    const mockUpdate = jest.fn();
    render(<EmployeeEdit employeeId="EMP001" onUpdate={mockUpdate} />);
    
    fireEvent.click(screen.getByText('保存'));
    
    await waitFor(() => {
      expect(mockUpdate).toHaveBeenCalledWith(expect.objectContaining({
        employee_id: 'EMP001'
      }));
    });
  });
});
```

### 14.2 統合テスト
- API連携テスト
- バリデーション統合テスト
- 権限制御テスト

### 14.3 E2Eテスト
```typescript
test('社員情報編集フロー', async ({ page }) => {
  await page.goto('/employees/edit/EMP001');
  
  // 氏名変更
  await page.fill('[data-testid="full-name"]', '田中次郎');
  
  // スキル追加
  await page.click('[data-testid="add-skill-button"]');
  await page.fill('[data-testid="skill-input"]', 'Vue.js');
  await page.click('[data-testid="confirm-add-skill"]');
  
  // 保存
  await page.click('[data-testid="save-button"]');
  
  // 詳細画面への遷移確認
  await expect(page).toHaveURL('/employees/detail/EMP001');
  await expect(page.locator('[data-testid="employee-name"]')).toContainText('田中次郎');
});
```

---

## チェックリスト
- [x] フォーム入力・バリデーション機能
- [x] リアルタイムバリデーション実装
- [x] 重複チェック機能
- [x] スキル管理機能
- [x] プレビュー機能実装
- [x] 自動保存・下書き機能
- [x] エラーハンドリング完備
- [x] アクセシビリティ対応
- [x] パフォーマンス最適化
- [x] テスト仕様策定