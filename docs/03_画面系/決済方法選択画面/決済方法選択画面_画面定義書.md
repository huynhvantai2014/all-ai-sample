# 画面定義書 - 決済方法選択画面

---

**画面名**：決済方法選択画面
**画面ID**：SRC0005
**画面物理名**：payment_method
**URL**：/payment_method

## 画面で使用するAPI一覧

### API 1: 利用可能決済方法取得API

---
**API ID**: PAY001
**API名**: 利用可能決済方法取得
**エンドポイント**: /api/payment/methods
**メソッド**: GET

#### 1. 機能概要 (Tóm tắt chức năng)
- 店舗・端末で利用可能な決済方法一覧を取得する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| storeId      | query | ○   | string | 20 | 店舗ID |
| terminalId   | query | ○   | string | 20 | 端末ID |
| amount       | query | ○   | number | 10,2 | 決済金額 |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| methods      | array | - | 利用可能決済方法リスト |
| methods[].id | string | 20 | 決済方法ID |
| methods[].name | string | 100 | 決済方法名 |
| methods[].type | string | 20 | 決済種別（cash/credit/ic/qr/installment） |
| methods[].icon | string | 500 | アイコンURL |
| methods[].isAvailable | boolean | - | 利用可能フラグ |
| methods[].minAmount | number | 10,2 | 最小利用金額 |
| methods[].maxAmount | number | 10,2 | 最大利用金額 |
| methods[].description | string | 255 | 説明・注意事項 |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 400    | 必須項目が入力されていません | パラメータ不足 |
| 404    | 店舗または端末が見つかりません | ID不正 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - storeId, terminalId, amountの必須チェック
    - amountの正数チェック
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương関/DB):
    - storesテーブルでstoreId存在チェック
    - terminalsテーブルでterminalId存在・有効性チェック
    - 不正な場合：404エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - payment_methodsテーブルから基本決済方法取得
    - store_payment_settingsテーブルで店舗別設定チェック
    - terminal_capabilitiesテーブルで端末対応状況チェック
    - 決済金額による利用可否判定（最小・最大金額チェック）
    - 各決済方法の利用可能状態計算
- 4. レスポンス生成 (Trả kết quả):
    - 利用可能決済方法リスト返却

#### 6. 備考 (Ghi chú)
- 決済金額により利用制限あり
- 端末機能による制限考慮

### API 2: 現金決済処理API

---
**API ID**: PAY002
**API名**: 現金決済処理
**エンドポイント**: /api/payment/cash
**メソッド**: POST

#### 1. 機能概要 (Tóm tắt chức năng)
- 現金決済を処理し、お釣り計算・領収書発行を行う

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| sessionId    | body | ○   | string | 50 | チェックアウトセッションID |
| totalAmount  | body | ○   | number | 10,2 | 請求金額 |
| receivedAmount | body | ○ | number | 10,2 | 受け取り金額 |
| cashierId    | body | ○   | string | 20 | レジ担当者ID |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| success      | boolean | - | 決済成功/失敗 |
| transactionId | string | 50 | 取引ID |
| changeAmount | number | 10,2 | お釣り金額 |
| receiptData  | object | - | 領収書データ |
| receiptData.receiptId | string | 30 | 領収書番号 |
| receiptData.printData | string | - | 印刷データ（JSON） |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 400    | 受け取り金額が不足しています | 金額不足 |
| 404    | セッションが見つかりません | sessionId不正 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - 必須項目チェック
    - receivedAmount >= totalAmountチェック
    - 金額の正数チェック
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương関/DB):
    - checkout_sessionsテーブルでsessionId存在・有効期限チェック
    - usersテーブルでcashierId存在チェック
    - 不正な場合：404エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - お釣り計算（receivedAmount - totalAmount）
    - 取引ID生成（TXN-YYYYMMDD-XXXXXXXX）
    - transactionsテーブルに取引記録
    - transaction_itemsテーブルに商品明細記録
    - cash_drawersテーブルでレジ現金管理更新
    - 領収書番号生成・領収書データ作成
    - チェックアウトセッション完了処理
- 4. レスポンス生成 (Trả kết quả):
    - 取引結果・お釣り・領収書データ返却

#### 6. 備考 (Ghi chú)
- レジ現金残高管理
- 領収書自動発行

### API 3: クレジットカード決済処理API

---
**API ID**: PAY003
**API名**: クレジットカード決済処理
**エンドポイント**: /api/payment/credit-card
**メソッド**: POST

#### 1. 機能概要 (Tóm tắt chức năng)
- クレジットカード決済を外部決済ゲートウェイ経由で処理する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| sessionId    | body | ○   | string | 50 | チェックアウトセッションID |
| totalAmount  | body | ○   | number | 10,2 | 請求金額 |
| cardNumber   | body | ○   | string | 20 | カード番号（暗号化） |
| expiryMonth  | body | ○   | string | 2  | 有効期限月 |
| expiryYear   | body | ○   | string | 4  | 有効期限年 |
| cvv          | body | ○   | string | 4  | セキュリティコード |
| cardholderName | body | ○ | string | 100 | カード名義人 |
| installmentPlan | body |  | number | 2 | 分割回数（一括の場合1） |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| success      | boolean | - | 決済成功/失敗 |
| transactionId | string | 50 | 取引ID |
| authorizationCode | string | 20 | 承認番号 |
| gatewayTransactionId | string | 50 | 決済ゲートウェイ取引ID |
| receiptData  | object | - | 領収書データ |
| errorCode    | string | 10 | エラーコード（失敗時） |
| errorMessage | string | 255 | エラーメッセージ（失敗時） |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 400    | カード情報が正しくありません | カード情報不正 |
| 402    | カードが利用できません | カード利用不可 |
| 402    | 決済が承認されませんでした | 決済拒否 |
| 404    | セッションが見つかりません | sessionId不正 |
| 500    | 決済システムエラーが発生しました | 決済GW障害 |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - 必須項目チェック
    - カード番号・有効期限・CVVの形式チェック
    - 分割回数の有効性チェック
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương关/DB):
    - checkout_sessionsテーブルでsessionId存在・有効期限チェック
    - installment_plansテーブルで分割プラン確認
    - 不正な場合：404エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - カード情報暗号化処理
    - 外部決済ゲートウェイAPI呼び出し
    - 決済結果判定（承認/拒否）
    - 承認時：
      - 取引ID生成・transactionsテーブル記録
      - transaction_itemsテーブルに商品明細記録
      - 承認番号・ゲートウェイ取引ID保存
      - 領収書データ生成
    - 拒否時：エラー情報記録
    - チェックアウトセッション完了処理
- 4. レスポンス生成 (Trả kết quả):
    - 決済結果・承認番号・領収書データ返却

#### 6. 備考 (Ghi chú)
- PCI DSS準拠のセキュリティ
- 分割払い対応

### API 4: QRコード決済処理API

---
**API ID**: PAY004
**API名**: QRコード決済処理
**エンドポイント**: /api/payment/qr-code
**メソッド**: POST

#### 1. 機能概要 (Tóm tắt chức năng)
- QRコード決済（PayPay、LINE Pay等）を処理する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| sessionId    | body | ○   | string | 50 | チェックアウトセッションID |
| totalAmount  | body | ○   | number | 10,2 | 請求金額 |
| qrProvider   | body | ○   | string | 50 | QR決済プロバイダ（paypay/linepay/rakutenpay等） |
| qrData       | body | ○   | string | 500 | QRコードデータ |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| success      | boolean | - | 決済成功/失敗 |
| transactionId | string | 50 | 取引ID |
| providerTransactionId | string | 50 | プロバイダ取引ID |
| receiptData  | object | - | 領収書データ |
| qrCodeUrl    | string | 500 | 決済用QRコードURL（顧客提示用） |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 400    | QRコードが正しくありません | QRデータ不正 |
| 400    | 対応していない決済方法です | プロバイダ未対応 |
| 402    | 決済がキャンセルされました | 顧客キャンセル |
| 404    | セッションが見つかりません | sessionId不正 |
| 500    | 決済システムエラーが発生しました | プロバイダ障害 |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - 必須項目チェック
    - qrProviderの対応確認
    - totalAmountの正数チェック
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương关/DB):
    - checkout_sessionsテーブルでsessionId存在・有効期限チェック
    - qr_providersテーブルでプロバイダ設定確認
    - 不正な場合：404エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - QRデータ解析・検証
    - 決済プロバイダAPI呼び出し
    - 決済用QRコード生成（顧客用）
    - 決済状態監視（ポーリングまたはWebhook）
    - 決済完了時：
      - 取引ID生成・transactionsテーブル記録
      - プロバイダ取引ID保存
      - 領収書データ生成
    - チェックアウトセッション完了処理
- 4. レスポンス生成 (Trả kết quả):
    - 決済結果・取引ID・QRコードURL返却

#### 6. 備考 (Ghi chú)
- 複数QR決済プロバイダ対応
- リアルタイム決済状態確認

### API 5: 決済結果確認API

---
**API ID**: PAY005
**API名**: 決済結果確認
**エンドポイント**: /api/payment/status/{transactionId}
**メソッド**: GET

#### 1. 機能概要 (Tóm tắt chức năng)
- 決済処理の状態・結果を確認する

#### 2. パラメータ定義 (Định nghĩa tham số)
| パラメータ名 | 種別 | 必須 | 型 | 桁数 | 説明 |
|--------------|------|------|----|------|------|
| transactionId | path | ○  | string | 50 | 取引ID |

#### 3. レスポンス定義 (Định nghĩa response)
| フィールド名 | 型 | 桁数 | 説明 |
|--------------|----|------|------|
| transactionId | string | 50 | 取引ID |
| status       | string | 20 | 決済状態（pending/completed/failed/cancelled） |
| paymentMethod | string | 50 | 決済方法 |
| totalAmount  | number | 10,2 | 決済金額 |
| completedAt  | datetime | - | 決済完了日時 |
| receiptData  | object | - | 領収書データ |

#### 4. エラーコード・メッセージ (Mã lỗi, message)
| コード | メッセージ | 条件 |
|--------|------------|------|
| 404    | 取引が見つかりません | transactionId不正 |
| 500    | システムエラーが発生しました | サーバーエラー |

#### 5. 処理フロー (Luồng xử lý API)
- 1. 入力バリデーション (Validate đầu vào):
    - transactionIdの必須チェック
    - 不正な場合：400エラー返却
- 2. 相関バリデーション (Validate tương关/DB):
    - transactionsテーブルでtransactionId存在チェック
    - 不正な場合：404エラー返却
- 3. 業務処理 (Xử lý nghiệp vụ):
    - 取引情報取得（transactionsテーブル）
    - 決済プロバイダから最新状態取得（必要に応じて）
    - 状態更新（必要に応じて）
- 4. レスポンス生成 (Trả kết quả):
    - 取引状態・詳細情報返却

#### 6. 備考 (Ghi chú)
- リアルタイム状態確認
- 領収書再発行可能

---

## 関連テーブル

- **payment_methods**: 決済方法マスタ
- **store_payment_settings**: 店舗別決済設定
- **terminal_capabilities**: 端末決済対応状況
- **transactions**: 取引記録
- **transaction_items**: 取引商品明細
- **cash_drawers**: レジ現金管理
- **installment_plans**: 分割払いプラン
- **qr_providers**: QR決済プロバイダ設定
- **checkout_sessions**: チェックアウトセッション

## 備考

- 複数決済方法対応（現金・クレジット・QR・分割等）
- 外部決済ゲートウェイ連携
- PCI DSS準拠セキュリティ
- リアルタイム決済状態管理
- 自動領収書発行機能